/**
 * angular-adn
 * @version v0.0.10 - 2013-08-26
 * @link https://github.com/appdotnet/angular-adn
 * @author App.net <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("adn",["ui"]),angular.module("adn").provider("ADNConfig",function(){this.configuation={},this.$get=function(){return{config:this.configuation,get:function(a,b){return this.config.hasOwnProperty(a)?this.config[a]:b}}},this.setConfig=function(a){this.configuation=angular.extend({},this.configuation,a)}}),angular.module("adn").factory("Auth",["$rootScope","$location",function(a,b){return a.local=JSON.parse("undefined"!=typeof localStorage.data?localStorage.data:"{}"),a.$watch("local",function(){localStorage.data=JSON.stringify(a.local)},!0),{isLoggedIn:function(b){return void 0===b&&(b=a.local),b&&"undefined"!=typeof b.accessToken},logout:function(){a.local={},localStorage.clear()},login:function(){a.local.accessToken=a.local.accessToken||jQuery.url(b.absUrl()).fparam("access_token"),b.hash("")}}}]),angular.module("adn").factory("ApiClient",["$rootScope","$http","ADNConfig",function(a,b,c){var d=["get","head","post","put","delete","jsonp"],e=function(d){return function(e){return e.headers=e.headers||{},a.local&&a.local.accessToken&&(e.headers.Authorization="Bearer "+a.local.accessToken),e.url=c.get("api_client_root","https://alpha-api.app.net/stream/0/")+e.url,e.method=d,"post"===d&&e.data&&!e.headers["Content-Type"]&&(e.data=jQuery.param(e.data),e.headers["Content-Type"]="application/x-www-form-urlencoded"),"get"===d&&e.data&&(e.url=e.url+"?"+jQuery.param(e.data)),b(e)}},f={};return _.each(d,function(a){f[a]=e(a)}),f.postJson=function(a){return a.headers=a.headers||{},a.headers["Content-Type"]="application/json",(!angular.isString(a.data)&&angular.isObject(a.data)||angular.isArray(a.data))&&(a.data=angular.toJson(a.data)),f.post(a)},f.createChannel=function(a){return f.post({url:"/channels",data:a})},f.updateChannel=function(a,b){return f.put({url:"/channels/"+a.id,data:b})},f.getBroadcastChannels=function(){return f.get({url:"/channels",params:{channel_types:"net.app.core.broadcast"}})},f.getChannel=function(a){return f.get({url:"/channels/"+a})},f.subscribeToChannel=function(a){return f.post({url:"/channels/"+a.id+"/subscribe"})},f.unsubscribeFromChannel=function(a){return f.delete({url:"/channels/"+a.id+"/subscribe"})},f.createMessage=function(a,b){return f.postJson({url:"/channels/"+a.id+"/messages",data:b})},f.getMessages=function(a,b){var c={url:"/channels/"+a.id+"/messages",data:{}};return b&&(c.data.include_annotations=1),f.get(c)},f.getMultipleUsers=function(a){return f.get({params:{ids:a}})},f.searchUsers=function(a){return f.get({params:a,url:"/users/search"})},f.getChannelMetadata=function(a){var b=_.find(a.annotations,function(a){return"net.app.core.broadcast.metadata"===a.type&&a.value.title&&a.value.description});return b?b.value:{title:"Channel "+a.id,description:""}},a.channels=[],f.getBroadcastChannels().success(function(b){a.channels=_.filter(b.data,function(a){return a.you_subscribed})}),f}]),function(){angular.module("adn").factory("User",["$http","$q","ApiClient",function(a,b,c){var d=function(a,b){a?this.complete(b):(b.is_complete=!1,angular.extend(this,b))};return d.prototype.complete=function(a){return angular.extend(this,a),this.is_complete=!0,this.text="@"+this.username+" ("+this.name+")",this},d._cache={},d._pending=[],d.update=function(a){if(a){var b=d._cache[a.id||0];return b?(d._pending=_.without(d._pending,b),b.complete(a)):(d._cache[a.id]=new d(!0,a),d._cache[a.id])}},d.bulk_get=function(a,c){var e={},f=b.defer();return _.each(_.uniq(a),function(a){var b=d._cache[a];b||(b=d._cache[a]=new d(!1,{id:a}),d._pending.push(b)),e[a]=b}),c?d.fetch_pending().then(function(){f.resolve(e)}):f.resolve(e),f.promise},d.fetch_pending=function(){var a=d._pending;d._pending=[];for(var e=function(a){_.each(a.data.data,function(a){d.update(a)})},f=[];a.length;){var g=_.first(a,200);a=_.rest(a,200);var h=_.pluck(g,"id").join(),i=c.getMultipleUsers(h);i.then(e),f.push(i)}return b.all(f)},d}])}(),function(){angular.module("adn").directive("adnText",function(){return{restrict:"A",link:function(a){a.offset=0,void 0===a.textData.rawText&&(a.textData.rawText=""),a.updateCounter=function(){a.charCount=a.maxChars-a.offset-a.textData.rawText.length},a.$watch("[maxChars, offset, textData]",a.updateCounter,!0),a.updateCounter(),a.buttonClick=function(){a.textData.rawText.length<=a.maxChars&&(a.textData.processedMessage={text:a.textData.rawText},a.onButtonClick())}},templateUrl:"templates/adn-text.html",scope:{buttonText:"@",onButtonClick:"&",maxChars:"@",textData:"="}}})}(),function(){angular.module("adn").controller("UserSearchCtrl",["$scope","User","ApiClient",function(a,b,c){var d=function(d){return{multiple:!0,minimumInputLength:1,tokenSeparators:[","," "],createSearchChoice:function(a){return a},width:"resolve",query:function(e){"@"!==e.term.charAt(0)&&"#"!==e.term.charAt(0)&&(e.term="@"+e.term);var f={q:e.term,include_users:d||"any"};c.searchUsers(f).success(function(a){var c=_.map(a.data,function(a){return b.update(a)});e.callback({results:c})}).error(function(){console.log("error",arguments)}).always(function(){console.log("always",arguments)}),a.$apply()}}};a.usernameSelect=d()}]),angular.module("adn").directive("userSearch",function(){return{restrict:"A",controller:"UserSearchCtrl",templateUrl:"templates/user-search.html",replace:!0,scope:{label:"=",selectedUsers:"=",include_users:"="}}})}(),angular.module("adn").run(["$templateCache",function(a){a.put("templates/adn-text.html",'<div class="well-plain well-elevated">\n    <div>\n        <textarea class="editable input-flex" ng-model="textData.rawText" ng-trim="false" tabindex=1></textarea>\n    </div>\n    <div>\n      <span class="text-left char-count">{{ charCount }}</span>\n      <span class="pull-right">\n        <button class="btn btn-primary btn-small" tabindex=2 ng-disabled="charCount < 0" ng-click="buttonClick()">{{ buttonText }}</button>\n      </span>\n    </div>\n</div>'),a.put("templates/user-search.html",'<div>\n  <!-- originally from ohe -->\n  <label class="control-label" ng-bind=\'label\'></label>\n  <input class=\'input-block-level\' type="hidden" ui-select2="usernameSelect" ng-model="selectedUsers" ng-multiple>\n</div>')}]);