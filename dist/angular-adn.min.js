/**
 * angular-adn
 * @version v0.0.26 - 2014-04-22
 * @link https://github.com/appdotnet/angular-adn
 * @author App.net <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("adn",["ui"]),angular.module("adn").provider("ADNConfig",function(){this.configuation={},this.$get=function(){return{config:this.configuation,get:function(a,b){return this.config.hasOwnProperty(a)?this.config[a]:b}}},this.setConfig=function(a){this.configuation=angular.extend({},this.configuation,a)}}),angular.module("adn").provider("Auth",function(){var a=function(){return{clear:function(){localStorage.clear()},get:function(a){return localStorage[a]},set:function(a,b){localStorage[a]=b}}}(),b=function(){var a={};return{clear:function(){a={}},get:function(b){return a[b]},set:function(b,c){a[b]=c}}}(),c={memory:b,localStorage:a},d={loggedIn:!1,accessToken:null},e=function(){return angular.extend({},d)},f=c.localStorage;this.$get=["$rootScope","$location",function(a,b){var c;return c="undefined"!=typeof f.get("user")?JSON.parse(f.get("user")):e(),{logout:function(){f.clear(),c=e(),a.$broadcast("logout")},login:function(d){c.accessToken=d||jQuery.url(b.absUrl()).fparam("access_token")||c.accessToken,c.accessToken&&(c.loggedIn=!0),f.set("user",JSON.stringify(c)),b.hash(""),a.$broadcast("login")},currentUser:function(){return c}}}],this.chooseStorageEngine=function(a){c[a]&&(f=c[a])}}),angular.module("adn").factory("ApiClient",["$rootScope","$http","ADNConfig","Auth",function(a,b,c,d){var e=["get","head","post","put","delete","jsonp"],f=function(a){return function(e,f){f=f||{},e.headers=e.headers||{};var g=d.currentUser();return g.loggedIn&&(e.headers.Authorization="Bearer "+g.accessToken),e=jQuery.extend(!0,{},f,e),e.url=c.get("api_client_root","https://alpha-api.app.net/stream/0/")+e.url,e.method=a,"post"===a&&e.data&&!e.headers["Content-Type"]&&(e.data=jQuery.param(e.data),e.headers["Content-Type"]="application/x-www-form-urlencoded"),b(e)}},g={};_.each(e,function(a){g[a]=f(a)});var h=function(a,b,c){return b.headers=b.headers||{},b.headers["Content-Type"]="application/json",(!angular.isString(b.data)&&angular.isObject(b.data)||angular.isArray(b.data))&&(b.data=angular.toJson(b.data)),g[a](b,c)};return g.postJson=function(a,b){return h("post",a,b)},g.putJson=function(a,b){return h("put",a,b)},g.createChannel=function(a,b){return g.postJson({url:"/channels",data:a},b)},g.updateChannel=function(a,b,c){return g.putJson({url:"/channels/"+a.id,data:b},c)},g.getBroadcastChannels=function(a){return g.get({url:"/users/me/channels",params:{channel_types:"net.app.core.broadcast",count:200}},a)},g.getChannel=function(a,b){return g.get({url:"/channels/"+a},b)},g.subscribeToChannel=function(a,b){return g.post({url:"/channels/"+a.id+"/subscribe"},b)},g.unsubscribeFromChannel=function(a,b){return g.delete({url:"/channels/"+a.id+"/subscribe"},b)},g.createMessage=function(a,b,c){return g.postJson({url:"/channels/"+a.id+"/messages",data:b},c)},g.getMessages=function(a,b){var c={url:"/channels/"+a.id+"/messages"};return g.get(c,b)},g.getMultipleUsers=function(a,b){return g.get({params:{ids:a}},b)},g.searchUsers=function(a,b){return g.get({params:a,url:"/users/search"},b)},g.getChannelMetadata=function(a){var b=_.find(a.annotations,function(a){return"net.app.core.broadcast.metadata"===a.type&&a.value.title&&a.value.description});return b?b.value:{title:"Channel "+a.id,description:""}},g}]),function(){angular.module("adn").factory("User",["$http","$q","ApiClient",function(a,b,c){var d=function(a,b){a?this.complete(b):(b.is_complete=!1,angular.extend(this,b))};return d.prototype.complete=function(a){return angular.extend(this,a),this.is_complete=!0,this.text="@"+this.username+" ("+this.name+")",this},d._cache={},d._pending=[],d.update=function(a){if(a){var b=d._cache[a.id||0];return b?(d._pending=_.without(d._pending,b),b.complete(a)):(d._cache[a.id]=new d(!0,a),d._cache[a.id])}},d.bulk_get=function(a,c){var e={},f=b.defer();return _.each(_.uniq(a),function(a){var b=d._cache[a];b||(b=d._cache[a]=new d(!1,{id:a}),d._pending.push(b)),e[a]=b}),c?d.fetch_pending().then(function(){f.resolve(e)}):f.resolve(e),f.promise},d.fetch_pending=function(){var a=d._pending;d._pending=[];for(var e=function(a){_.each(a.data.data,function(a){d.update(a)})},f=[];a.length;){var g=_.first(a,200);a=_.rest(a,200);var h=_.pluck(g,"id").join(),i=c.getMultipleUsers(h);i.then(e),f.push(i)}return b.all(f)},d}])}(),function(){angular.module("adn").directive("adnText",function(){return{restrict:"A",link:function(a){a.offset=0,void 0===a.textData.rawText&&(a.textData.rawText=""),a.updateCounter=function(){a.charCount=a.maxChars-a.offset-a.textData.rawText.length},a.$watch("[maxChars, offset, textData]",a.updateCounter,!0),a.updateCounter(),a.buttonClick=function(){a.textData.rawText.length<=a.maxChars&&(a.textData.processedMessage={text:a.textData.rawText},a.onButtonClick())}},templateUrl:"templates/adn-text.html",scope:{buttonText:"@",onButtonClick:"&",maxChars:"@",textData:"="}}})}(),function(){angular.module("adn").controller("UserSearchCtrl",["$scope","User","ApiClient",function(a,b,c){var d=function(d){return{multiple:!0,minimumInputLength:1,tokenSeparators:[","," "],createSearchChoice:function(a){return a},width:"resolve",query:function(e){"@"!==e.term.charAt(0)&&"#"!==e.term.charAt(0)&&(e.term="@"+e.term);var f={q:e.term,include_users:d||"any"};c.searchUsers(f).success(function(a){var c=_.map(a.data,function(a){return b.update(a)});e.callback({results:c})}),a.$apply()}}};a.usernameSelect=d()}]),angular.module("adn").directive("userSearch",function(){return{restrict:"A",controller:"UserSearchCtrl",templateUrl:"templates/user-search.html",replace:!0,scope:{label:"=",selectedUsers:"=",include_users:"="}}})}(),angular.module("adn").run(["$templateCache",function(a){a.put("templates/adn-text.html",'<div class="well-plain well-elevated">\n    <div>\n        <textarea class="editable input-flex" ng-model="textData.rawText" ng-trim="false" tabindex=1></textarea>\n    </div>\n    <div>\n      <span class="text-left char-count">{{ charCount }}</span>\n      <span class="pull-right">\n        <button class="btn btn-primary btn-small" tabindex=2 ng-disabled="charCount < 0" ng-click="buttonClick()">{{ buttonText }}</button>\n      </span>\n    </div>\n</div>'),a.put("templates/user-search.html",'<div>\n  <!-- originally from ohe -->\n  <label class="control-label" ng-bind=\'label\'></label>\n  <input class=\'input-block-level\' type="hidden" ui-select2="usernameSelect" ng-model="selectedUsers" ng-multiple>\n</div>')}]);